@inject IJSRuntime JS
@using DiscountApp.Components.Shared

@* Reusable Discount Card Component *@
<div class="bg-white rounded-lg shadow-sm overflow-hidden hover:shadow-md transition-shadow mb-6">
    <QRCodeModal IsVisible="@showQRModal" Code="@DiscountCode" MerchantName="@MerchantName"
        OnClose="@(() => showQRModal = false)" />
    <div class="p-6">
        <!-- Header with Logo and Name -->
        <div class="flex items-center space-x-3 mb-4">
            <img src="@MerchantLogo" alt="@MerchantName logo" class="h-10 w-10 rounded-full object-contain" />
            <h4 class="text-lg font-semibold text-gray-900">@MerchantName</h4>
        </div>

        <!-- Description -->
        <p class="text-gray-600 mb-4">@Description</p>

        <!-- Discount and Price Row -->
        <div class="flex items-center justify-between mb-4">
            <div class="bg-gray-100 px-3 py-1 rounded-md inline-block">
                <span class="text-2xl font-bold text-gray-900">@DiscountPercentage%</span>
                <span class="text-gray-600">rabatt</span>
            </div>
            @if (Price > 0)
            {
                <div class="px-3 py-1 rounded-md bg-gray-100 text-gray-900 font-semibold">
                    @FormattedPrice
                </div>
            }
        </div>

        <!-- Available codes badge -->
        @if (ShowAvailableCodes)
        {
            <div class="flex justify-end -mt-2 mb-4">
                <span
                    class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-orange-50 text-orange-700 border border-orange-200">
                    Koder igjen: @AvailableCodes
                </span>
            </div>
        }

        @if (ShowCode)
        {
            <!-- Discount Code Section (for claimed codes) -->
            <div class="mt-4 p-4 bg-orange-50 rounded-lg border border-orange-200">
                <p class="text-sm text-gray-600 mb-2">Din rabattkode:</p>
                <div class="flex items-center gap-2 mb-3">
                    <code
                        class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded-xl font-mono text-lg font-bold text-gray-900">
                                                                        @DiscountCode
                                                                    </code>
                    <button @onclick="HandleCopyCode"
                        class="px-4 py-2 bg-orange-600 text-white rounded-xl hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-400 transition-colors">
                        @if (isCopied)
                        {
                            <span>✓</span>
                        }
                        else
                        {
                            <span>Kopier</span>
                        }
                    </button>
                </div>

                <!-- QR Code Button -->
                <button @onclick="ShowQRCode"
                    class="w-full inline-flex items-center justify-center px-4 py-2 bg-white border-2 border-orange-500 text-orange-600 font-semibold rounded-xl hover:bg-orange-50 focus:outline-none focus:ring-2 focus:ring-orange-400 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z">
                        </path>
                    </svg>
                    Vis QR-kode
                </button>
            </div>

            <!-- Link to Merchant Website (in-app webview) -->
            <button @onclick="NavigateToWebView"
                class="mt-4 w-full inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-semibold rounded-xl hover:from-orange-600 hover:to-orange-700 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 transition-all duration-150">
                Åpne nettsiden i appen
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
            </button>
        }
        else
        {
            <!-- Action Button (for available discounts) -->
            <div class="flex items-center justify-between mt-4">
                <button @onclick="OnAction"
                    class="group relative inline-flex items-center justify-center px-6 py-3 overflow-hidden font-bold text-white rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all duration-150 ease-out">
                    <span
                        class="absolute right-0 w-8 h-32 -mt-12 transition-all duration-1000 transform translate-x-12 bg-white opacity-10 rotate-12 group-hover:-translate-x-40 ease pointer-events-none"></span>
                    <div class="flex items-center space-x-2">
                        <span>@ActionButtonText</span>
                        <svg class="w-5 h-5 transition-transform group-hover:translate-x-1" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                        </svg>
                    </div>
                </button>
            </div>
        }
    </div>
</div>

@code {
    private bool isCopied = false;
    private bool showQRModal = false;

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;
    private static readonly System.Globalization.CultureInfo NbNo =
    System.Globalization.CultureInfo.GetCultureInfo("nb-NO");
    private string FormattedPrice => Price.ToString("C0", NbNo);

    [Parameter]
    public string MerchantName { get; set; } = "";

    [Parameter]
    public string MerchantLogo { get; set; } = "";

    [Parameter]
    public string Description { get; set; } = "";

    [Parameter]
    public int DiscountPercentage { get; set; }

    [Parameter]
    public bool ShowCode { get; set; } = false;

    [Parameter]
    public decimal Price { get; set; }

    [Parameter]
    public string DiscountCode { get; set; } = "";

    [Parameter]
    public string MerchantWebsite { get; set; } = "";

    [Parameter]
    public EventCallback OnAction { get; set; }

    [Parameter]
    public string ActionButtonText { get; set; } = "Kjøp";

    [Parameter]
    public int AvailableCodes { get; set; }

    [Parameter]
    public bool ShowAvailableCodes { get; set; } = true;

    private async Task HandleCopyCode()
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", DiscountCode);
            isCopied = true;
            StateHasChanged();

            // Reset the "Copied!" message after 2 seconds
            await Task.Delay(2000);
            isCopied = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to copy to clipboard: {ex.Message}");
        }
    }

    private void NavigateToWebView()
    {
        // Build query with encoded parameters
        var url = Uri.EscapeDataString(MerchantWebsite ?? string.Empty);
        var code = Uri.EscapeDataString(DiscountCode ?? string.Empty);
        var merchant = Uri.EscapeDataString(MerchantName ?? string.Empty);
        Navigation.NavigateTo($"/webview?url={url}&code={code}&merchant={merchant}", forceLoad: true);
    }

    private void ShowQRCode()
    {
        showQRModal = true;
    }
}